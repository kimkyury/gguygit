---
import BaseLayout from './BaseLayout.astro';
import BookReader from '../components/BookReader.astro';
import PostHeroHeader from '../components/PostHeroHeader.astro';

const { title, date, datePublished, rating, youtube, summary, cover } = Astro.props;

const getYouTubeId = (url?: string): string | null => {
  if (!url) return null;
  try {
    const parsed = new URL(url);
    if (parsed.hostname.includes('youtu.be')) {
      return parsed.pathname.replace('/', '');
    }
    if (parsed.searchParams.has('v')) {
      return parsed.searchParams.get('v');
    }
    if (parsed.pathname.includes('/embed/')) {
      return parsed.pathname.split('/embed/')[1];
    }
    if (parsed.pathname.includes('/shorts/')) {
      return parsed.pathname.split('/shorts/')[1];
    }
    return null;
  } catch {
    return url;
  }
};

const youtubeId = getYouTubeId(youtube);
const ratingValue =
  typeof rating === 'number' ? Math.max(0, Math.min(5, Math.round(rating))) : null;
const ratingText =
  ratingValue !== null ? '★'.repeat(ratingValue) + '☆'.repeat(5 - ratingValue) : null;
const siteUrl = Astro.site ?? new URL('https://ggugit.pages.dev');
const canonical = new URL(Astro.url.pathname, siteUrl).toString();
const image = new URL(cover ?? '/images/culture-cover-1.png', siteUrl).toString();

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description: summary ?? title,
  image: [image],
  datePublished,
  dateModified: datePublished,
  author: {
    '@type': 'Person',
    name: 'KKGUL'
  },
  publisher: {
    '@type': 'Organization',
    name: 'GGuGit'
  },
  mainEntityOfPage: canonical
};

const reviewSchema = {
  '@context': 'https://schema.org',
  '@type': 'Review',
  name: title,
  reviewBody: summary ?? title,
  datePublished,
  author: {
    '@type': 'Person',
    name: 'KKGUL'
  },
  itemReviewed: {
    '@type': 'CreativeWork',
    name: title,
    image
  },
  reviewRating: ratingValue
    ? {
        '@type': 'Rating',
        ratingValue: String(ratingValue),
        bestRating: '5',
        worstRating: '1'
      }
    : undefined
};

const structuredData = ratingValue ? reviewSchema : articleSchema;
---

<BaseLayout
  title={title}
  description={summary ?? title}
  ogImage={cover ?? '/images/culture-cover-1.png'}
  ogType="article"
  structuredData={structuredData}
>
  <article class="echoes-post">
    <PostHeroHeader
      category="여운"
      title={title}
      date={date}
      summary={summary}
      rightMeta={ratingText ? `${date} · ${ratingText}` : date}
    />

    <div class="media">
      {youtubeId ? (
        <iframe
          src={`https://www.youtube.com/embed/${youtubeId}`}
          title={title}
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      ) : (
        <div class="media-placeholder">No video</div>
      )}
    </div>

    <BookReader summary={summary}>
      <slot />
    </BookReader>
  </article>
</BaseLayout>

<style>
  .echoes-post {
    display: grid;
    gap: 28px;
  }

  .media {
    position: relative;
    border-radius: 18px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.35);
    border: 1px solid rgba(27, 26, 23, 0.12);
    aspect-ratio: 16 / 9;
  }

  .media iframe {
    border: none;
    width: 100%;
    height: 100%;
  }

  .media-placeholder {
    display: grid;
    place-items: center;
    height: 100%;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.8rem;
  }

</style>
